
---
- name: Playbook copy ssh key 
  hosts: SERVER-B
  become: yes
  
  vars_files:
    - vars.yml 


  tasks:
  
  #delete autentication password
   - name: off autentifacation for password  
     command: sed -i 's/PasswordAuthentication yes/PasswordAuthentication no/' /etc/ssh/sshd_config
   - name: restart ssh
     service: name=ssh state=restarted enabled=yes
  

#create user and add privilege
   - name: create user DevOps
     user:
      name: DevOps
      system: yes
      comment: "DevOps user"
   - name: sudo no password
     command:  echo 'DevOps ALL=(ALL:ALL) NOPASSWD":" ALL' | tee -a /etc/sudoers.d/DevOps

#apt update
   - name: update packages
     apt: update_cache=yes cache_valid_time=3600 

#insllition postgresql for server-b
   - name: installation postgresql
     apt: "name=postgresql state=latest" 
  
   - name: "Install pip"
     apt: "name=python3-pip state=latest"

   - name: "Install python packages"
     pip: "name=psycopg2-binary state=present"

#create database
   - name: create database myapp and myauth
     postgresql_db:
      name: "{{ item }}"
      state: present
     become: yes
     become_user: postgres
     with_items:
      - "{{ db_name1 }}"
      - "{{ db_name2 }}"

#create user for postgres
   - name: "Create db user"
     postgresql_user:
      state: present
      name: "{{ db_user }}"
      password: "{{ db_password }}"
     become: yes
     become_user: postgres

#Grand {{ db_name1 }} db user1
   - name: "Grand db user access1"
     postgresql_privs:
      type: database 
      database: "{{ db_name1 }}"
      roles:  "{{ db_user  }}"
      grant_option: no
      privs: all
     become: yes
     become_user: postgres

#Grand {{ db_name2 }} db user2
   - name: "Grand db user access2"
     postgresql_privs:
      type: database
      database: "{{ db_name2 }}"
      roles: "{{ db_user }}"
      grant_option: no
      privs: CONNECT, TEMPORARY
     become: yes
     become_user: postgres
 
  handlers:
   - name: "restart postgresql"
     service: name=postgresql state=restarted   
